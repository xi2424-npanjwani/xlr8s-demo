AWSTemplateFormatVersion: 2010-09-09
Description: Template for creating an MQSeries Launch Template and Instance

Outputs:
  MQInstance1PublicIP:
    Description: "The public IP address of the first MQ instance"
    Value: !GetAtt MQInstance1.PublicIp

Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'General Parameters'
      Parameters:
      - ProjectName
      - managedByTower
      - blockCode
      - InstanceType
      - NumberOfInstances
      - osVersion
      - Environment
      - EC2IAMInstanceProfileName
      - ServerType
      - DomainEnv
      - ApplicationNumber
    - Label:
        default: 'Load Balancer Paramaters'
      Parameters:
      - AppFriendlyName
      - SubnetSelection1
      - SubnetSelection2
      - StickinessEnabled
      - StickinessDuration
    - Label:
        default: 'Patching Parameters'
      Parameters:
      - OSPatchDay1
      - OSPatchHour1
      - ProductPatchDay1
      - ProductPatchHour1
      - ProdOOBPatchGroup1
      - OSPatchDay2
      - OSPatchHour2
      - ProductPatchDay2
      - ProductPatchHour2
      - ProdOOBPatchGroup2
    - Label:
        default: 'Filesystem Sizes'
      Parameters:
      - AppsVolumeSize
      - ProductsVolumeSize
      - LogsVolumeSize
    - Label:
        default: 'MQSeries Parameters'
      Parameters:
      - infraAppVersion
      - appSupportEmail
      - infraAppSupportEmail
    - Label:
        default: 'Sailpoint Integration Parameters'
      Parameters:
      - AdminPrimaryOwner
      - AdminSecondaryOwners
      - ApplicationPrimaryOwner
      - ApplicationSecondaryOwners
      - gdprIndicator
      - piiIndicator
    - Label:
        default: 'General Tagging Parameters'
      Parameters:
      - costCenter
      - uniqueId
      - dataClassification
      - supportGroup
      - changeGroup
      - drTier
      - pciIndicator
      - phiIndicator
      - cuiIndicator
      - soxIndicator

Parameters:

  # GENERAL PARAMETERS
  ProjectName:
    Type: String
    Description: Enter the name for the project
    Default: "Xlr8s"
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: The name of the SSH key pair to allow access to the instance
    ConstraintDescription: Must be the name of an existing EC2 KeyPair.
    Default: rishabh_bhatnagar_ssh_key
  managedByTower:
    Type: String
    AllowedValues: ['true', 'false']
    Default: 'false'
  blockCode:
    Type: String
    Description: Enter the block code for the project
    AllowedPattern: ^[a-zA-Z0-9]{10}$
    Default: "xlr8s12345"
  InstanceType:
    Type: String
    Description: Select the instance type you would like to use in your launch templates
    AllowedValues: ['t3.micro', 't2.micro', 't3.small', 't2.small','t3.medium', 't3.large', 't3.xlarge', 't3.2xlarge','t3a.medium', 't3a.large', 't3a.xlarge', 't3a.2xlarge']
    Default: t3.small
  Ami:
    Type: String
    Description: The ami to be used for launching the instance
    Default: "ami-0c76ded57b818ac02" 
    #"ami-03e9149278a6f457c"
  NumberOfInstances:
    Type: Number
    Description: The number of instances you would like to have behind the load balancer
    Default: 1
    # AllowedValues: [1]
  osVersion:
    Type: String
    Description: Select the RHEL OS Version you would like to use
    AllowedValues: ['rhel-7x', 'rhel-8x']
    Default: "rhel-8x"
  Environment:
    Type: String
    Default: development
  EC2IAMInstanceProfileName:
    Type: String
    Description: The Arn of the IAM Instance Profile that should be used when creating the EC2 Launch Template
    Default: DeltaMigrationEC2Role
  ServerType:
    Type: String
    AllowedValues:
      - application
      - database
      - dc
      - citrix
      - web
    Default: application
  DomainEnv:
    Type: String
    Default: Delta.RL.Delta.com
    AllowedValues:
      - Delta.RL.Delta.com
      - VAD.VS.AIR4.com
  ApplicationNumber:
    Type: String
    Description: The 2 digit Application Number.  This number will be used when creating the Application Alias DNS.
    AllowedPattern: ^[0-9]{2}$
    Default: '01'

  VpcId:
    Type: String
    Description: The vpc id to launch the instance in
    Default: 'vpc-054d1a3db9b2d4c05'

  SubnetId:
    Type: String
    Description: The subnet id to launch the instance in
    Default: 'subnet-09a2db7fdac92e25c'

  # LOAD BALANCER PARAMETERS
  AppFriendlyName:
    Type: String
    Description: The friendly DNS name for this application.  If this is unknown please leave this as 'none' and a temporary DNS name will be created.
    Default: none
  SubnetSelection1:
    Type: String
    Description: Please select the first subnet in which to create your Application Load Balanacer and Instance. One of the NLBs and the first and third instances (if applicable) will be created in this subnet.
    AllowedValues: ['webappsubnet1aid', 'webappsubnet1bid','webappsubnet1cid','webappsubnet2aid', 'webappsubnet2bid','webappsubnet2cid']
    Default: "webappsubnet1aid"
  SubnetSelection2:
    Type: String
    Description: Please select the second subnet in which to create your Application Load Balanacer and Instance. One of the NLBs and the second and fourth instances (if applicable) will be created in this subnet.
    AllowedValues: ['webappsubnet1aid', 'webappsubnet1bid','webappsubnet1cid','webappsubnet2aid', 'webappsubnet2bid','webappsubnet2cid']
    Default: "webappsubnet1aid"

  # PATCHING PARAMETERS
    # OS PATCHING
  OSPatchDay1:
    Type: String
    Description: The day that you would like the OS on the odd numbered instances patched on.  Non-prd instances will get patched on Tue-Fri of the 1st week of the 14-day patch cycle whereas prd instances will get patched on Mon-Fri of the 2nd week of the 14-day patch cycle.
    AllowedValues: ['mon','tue','wed','thu','fri']
    Default: 'mon'
  OSPatchHour1:
    Type: String
    Description: The hour that you would like the OS on the odd numbered instances patched on.  Non-prd instances will get patched on Tue-Fri of the 1st week of the 14-day patch cycle whereas prd instances will get patched on Mon-Fri of the 2nd week of the 14-day patch cycle.
    AllowedValues: ['01', '03','19','22']
    Default: '01'
  OSPatchDay2:
    Type: String
    Description: The day that you would like the OS on the even numbered instances patched on.  Non-prd instances will get patched on Tue-Fri of the 1st week of the 14-day patch cycle whereas prd instances will get patched on Mon-Fri of the 2nd week of the 14-day patch cycle.
    AllowedValues: ['mon','tue','wed','thu','fri']
    Default: 'mon'
  OSPatchHour2:
    Type: String
    Description: The hour that you would like the OS on the even numbered instances patched on.  Non-prd instances will get patched on Tue-Fri of the 1st week of the 14-day patch cycle whereas prd instances will get patched on Mon-Fri of the 2nd week of the 14-day patch cycle.
    AllowedValues: ['01', '03','19','22']
    Default: '19'
    #MQSERIES PRODUCT PATCHING
  ProductPatchDay1:
    Type: String
    Description: The day that you would like MQSERIES on the odd numbered instances patched on.  Non-prd instances will get patched on Tue-Fri of the 1st week of the 14-day patch cycle whereas prd instances will get patched on Mon-Fri of the 2nd week of the 14-day patch cycle.
    AllowedValues: ['mon','tue','wed','thu','fri']
    Default: 'tue'
  ProductPatchHour1:
    Type: String
    Description: The hour that you would like MQSERIES on the odd numbered instances patched on.  Non-prd instances will get patched on Tue-Fri of the 1st week of the 14-day patch cycle whereas prd instances will get patched on Mon-Fri of the 2nd week of the 14-day patch cycle.
    AllowedValues: ['01', '03','19','22']
    Default: '01'
  ProductPatchDay2:
    Type: String
    Description: The day that you would like MQSERIES on the even numbered instances patched on.  Non-prd instances will get patched on Tue-Fri of the 1st week of the 14-day patch cycle whereas prd instances will get patched on Mon-Fri of the 2nd week of the 14-day patch cycle.
    AllowedValues: ['mon','tue','wed','thu','fri']
    Default: 'tue'
  ProductPatchHour2:
    Type: String
    Description: The hour that you would like MQSERIES on the even numbered instances patched on.  Non-prd instances will get patched on Tue-Fri of the 1st week of the 14-day patch cycle whereas prd instances will get patched on Mon-Fri of the 2nd week of the 14-day patch cycle.
    AllowedValues: ['01', '03','19','22']
    Default: '19'
    #OUT OF BAND PATCHING
  ProdOOBPatchGroup1:
    Type: String
    Description: The Out of Band (OOB) patch schedule you would like to use for the odd numbered instances.  Note that this only applies to production instances.
    AllowedValues: ['prd-day-3-2000','prd-day-4-2200','prd-day-5-2400','prd-day-6-0200','prd-day-7-0400']
    Default: 'prd-day-4-2200'
  ProdOOBPatchGroup2:
    Type: String
    Description: The Out of Band (OOB) patch schedule you would like to use for the even numbered instances.  Note that this only applies to production instances.
    AllowedValues: ['prd-day-3-2000','prd-day-4-2200','prd-day-5-2400','prd-day-6-0200','prd-day-7-0400']
    Default: 'prd-day-5-2400'

  # FILESYSTEM SIZE PARAMETERS
  AppsVolumeSize:
    Type: Number
    Description: Enter the volume size for the apps volume
    Default: 10
  ProductsVolumeSize:
    Type: Number
    Description: Enter the volume size for the products volume
    Default: 15
  LogsVolumeSize:
    Type: Number
    Description: Enter the volume size for the logs volume
    Default: 10

  # MQSERIES PARAMETERS
  infraAppVersion:
    Type: String
    Description: The product version of MQSERIES to use
    AllowedValues: ['9.2.3']
    Default: '9.2.3'
  infraAppSupportEmail:
    Type: String
    Description: Select the Web Engineering SME assigned for the project
    # AllowedValues: ['Dinesh.Atchala']
    Default: "Dinesh.Atchala"
  appSupportEmail:
    Type: String
    Description: Enter the application team support email
    Default: "Dinesh.Atchala"

  # SAILPOINT PARAMETERS
  AdminPrimaryOwner:
    Type: String
    Description: Primary owner user id (6 digit) that should be set on the Admin AD group which sailpoint creates
    Default: "123456"
  AdminSecondaryOwners:
    Type: String
    Description: Comma delimited list of secondary owner user ids (6 digit) that should be set on the Admin AD group which sailpoint creates
    Default: "123456"
  gdprIndicator:
    Type: String
    Description: Refers to the general data protection regulation category of information
    AllowedValues: ['true', 'false']
    Default: 'false'
  piiIndicator:
    Type: String
    Description: Refers to any personal identifiable information related to an individual.
    AllowedValues: ['true', 'false']
    Default: 'false'

  # GENERAL TAGGING PARAMETERS
  costCenter:
    Description: The value for the costCenter tag .
    Type: String
    Default: 'xlr8s'
  uniqueId:
    Description: The unique ideentifier for the instance
    Type: String
    Default: 'xlr8s-cft'
  dataClassification:
    Description: The value for the dataClassificationParameter tag
    Type: String
    AllowedValues: ['internal', 'public', 'confidential', 'restricted']
    Default: internal
  supportGroup:
    Description: The value for the supportGroup tag
    Type: String
    Default: "xlr8s"
  changeGroup:
    Description: Identifies the ServiceNow group of the application owner who owns the AWS resource. The tag value needs to be an exact match of the ServiceNow group.
    Type: String
    Default: "Xlr8s"
  drTier:
    Type: String
    Description: A tier designation, which defines the chronological order of recovery for an application during an IT Disaster event.
    AllowedValues: ['mission vital','mission critical','business critical','business essential','business']
    Default: 'business critical'
  phiIndicator:
    Type: String
    Description: Refers to any health information (medical and insurance) related to an individual.
    AllowedValues: ['true', 'false']
    Default: 'false'
  pciIndicator:
    Type: String
    Description: Refers to the category used for credit cardholder data and sensitive authentication data.
    AllowedValues: ['true', 'false']
    Default: 'false'
  soxIndicator:
    Type: String
    Description: Refers to any information that has a direct and material impact on Delta’s financial reporting.
    AllowedValues: ['true', 'false']
    Default: 'false'
  cuiIndicator:
    Type: String
    Description: Refers to the category of unclassified information within the U.S. Federal government. Confidential.
    AllowedValues: ['true', 'false']
    Default: 'false'

Mappings:
  StickinessDurationMap:
    "Short-Lived":
      "duration": 300  #5 min
    "Long-Lived":
      "duration": 1800  #30 min
  ProductMap:
    "was":
      "abbreviation": "w"
    "apache":
      "abbreviation": "a"
    "eap":
      "abbreviation": "j"
    "openjdk":
      "abbreviation": "o"
    "tomcat":
      "abbreviation": "t"
    "mqseries":
      "abbreviation": "q"
  SubnetMap:
    "webappsubnet1aid":
      "dnssuffix": "1a"
    "webappsubnet1bid":
      "dnssuffix": "1b"
    "webappsubnet1cid":
      "dnssuffix": "1c"
    "webappsubnet2aid":
      "dnssuffix": "2a"
    "webappsubnet2bid":
      "dnssuffix": "2b"
    "webappsubnet2cid":
      "dnssuffix": "2c"
  DataClassificationMap:
    "internal":
      "SailpointDataClassification": "None"
    "public":
      "SailpointDataClassification": "None"
    "confidential":
      "SailpointDataClassification": "Confidential"
    "restricted":
      "SailpointDataClassification": "Restricted"
  EnvironmentMap:
    sandbox:
      "singleAbbreviation": "l"
      "abbreviation": "lab"
      "patchabbreviation": "lab"
      "mainCategory": "nonprd"
      "oobPatchGroup": "dev-day-1-1800"
    development:
      "singleAbbreviation": "d"
      "abbreviation": "dvl"
      "patchabbreviation": "dev"
      "mainCategory": "nonprd"
      "oobPatchGroup": "dev-day-1-1800"
    systems-integration:
      "singleAbbreviation": "i"
      "abbreviation": "int"
      "patchabbreviation": "si"
      "mainCategory": "nonprd"
      "oobPatchGroup": "si-day-2-1800"
    production:
      "singleAbbreviation": "p"
      "abbreviation": "prd"
      "patchabbreviation": "prd"
      "mainCategory": "prd"
      "oobPatchGroup": "not applicable"
    aws-central-services:
      "singleAbbreviation": "p"
      "abbreviation": "prd"
      "patchabbreviation": "prd"
      "mainCategory": "prd"
      "oobPatchGroup": "not applicable"
  RegionMap:
    us-east-1:
      "abbreviation": "NV"
      "onpremprefixlist": "pl-05a3c87e010904082"
    us-west-2:
      "abbreviation": "OR"
      "onpremprefixlist": "pl-0f41ed4a1130c377f"
    ap-south-1:
      "abbreviation": "NV"
      "onpremprefixlist": "pl-05a3c87e010904082"
  WebSMEemailMap:
    Gregory.Brown:
      "abbreviation": "Gregory.Brown@delta.com"
    Sandeep.Chedalawada:
      "abbreviation": "sandeep.chedalawada@delta.com"
    Dinesh.Atchala:
      "abbreviation": "dinesh.atchala@delta.com"

Conditions:
  IsManagedByTower: !Equals
    - !Ref managedByTower
    - 'true'
  IsManagedByNonPrdTower: !And
    - !Not [!Equals ["production", !Ref Environment]]
    - !Equals ['true', !Ref managedByTower]
  IsProductionAccount: !Equals
    - !Ref Environment
    - 'production'
  IsDevelopmentAccount: !Equals
    - !Ref Environment
    - 'development'
  IsSystemsIntegrationAccount: !Equals
    - !Ref Environment
    - 'systems-integration'
  IsAppFriendlyNameNotDefined: !Equals
    - !Ref AppFriendlyName
    - none
  Instance2:
    !Not [!Equals [!Ref NumberOfInstances, 1]]
  isBaseApplication: !Equals
    - !Ref ApplicationNumber
    - '01'

Resources:

#NLB
  # NLBCName:
  #   Type: AWS::Route53::RecordSet
  #   Properties:
  #     HostedZoneId: '{{resolve:ssm:/delta/r53/hostedzoneid:1}}'
  #     Name: !Sub
  #       - "v${blockCode}${ApplicationNumber}.${hostedzonedomain}"
  #       - {hostedzonedomain: '{{resolve:ssm:/delta/r53/hostedzonename:1}}'}
  #     Type: CNAME
  #     TTL: '300'
  #     ResourceRecords:
  #     - !GetAtt NLB.DNSName
  # NLBCertificate:
  #   Type: AWS::CertificateManager::Certificate
  #   Properties:
  #     CertificateAuthorityArn: !Sub '{{resolve:ssm:/delta/acm/pca/arn:1}}'
  #     DomainName: !Sub
  #         - "v${blockCode}${ApplicationNumber}.${hostedzonedomain}"
  #         - {hostedzonedomain: '{{resolve:ssm:/delta/r53/hostedzonename:1}}'}
  #     SubjectAlternativeNames:
  #       - !If
  #         - IsAppFriendlyNameNotDefined
  #         - !Ref AWS::NoValue
  #         - !Ref AppFriendlyName
  NLB:
    Type: "AWS::ElasticLoadBalancingV2::LoadBalancer"
    # DependsOn: NLBCertificate
    Properties:
        Name: !Sub "v${blockCode}${ApplicationNumber}-nlb"
        Scheme: "internal"
        Type: "network"
        Subnets:
          - !Ref SubnetId
          # - !Sub '{{resolve:ssm:/delta/vpc/${SubnetSelection2}:1}}'
        IpAddressType: "ipv4"
        LoadBalancerAttributes:
          -
            Key: "access_logs.s3.enabled"
            Value: "false"
          -
            Key: "deletion_protection.enabled"
            Value: "false"
  NLBListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      LoadBalancerArn: !Ref NLB
      Port: 1414
      Protocol: "TCP"
      # SslPolicy: "ELBSecurityPolicy-TLS-1-2-Ext-2018-06"
      # Certificates:
      #   -
      #     CertificateArn: !Ref NLBCertificate
      DefaultActions:
        -
          Order: 1
          TargetGroupArn: !Ref NLBTargetGroup
          Type: "forward"
  NLBTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    Properties:
      HealthCheckIntervalSeconds: 10
      Port: 1414
      Protocol: "TCP"
      HealthCheckPort: 1414
      HealthCheckProtocol: "TCP"
      UnhealthyThresholdCount: 2
      Targets: !If
        - Instance2
        - - Id: !Ref MQInstance1
            Port: 1414
          - Id: !Ref MQInstance2
            Port: 1414
        - - Id: !Ref MQInstance1
            Port: 1414
      HealthyThresholdCount: 2
      VpcId: !Ref VpcId
      Name: !Sub "${blockCode}${ApplicationNumber}-targetgroup"
      HealthCheckEnabled: true

#EC2
  MQSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: !Sub "Security group for ${blockCode} EC2"
      GroupName: !Sub
        - ${reg}-${env}-${os}-${tier}-${blockCode}-${ApplicationNumber}
        -  {
          reg:  !FindInMap [RegionMap, !Ref "AWS::Region", "abbreviation"],
          env:  !If [IsProductionAccount, 'P', !If [IsSystemsIntegrationAccount, 'S', 'D']],
          os:   'L',  #LINUX
          tier: 'A'  #Application
          }
      Tags:
      -
        Key: "Name"
        Value: !Sub
          - ${reg}-${env}-${os}-${tier}-${blockCode}-${ApplicationNumber}
          -  {
            reg:  !FindInMap [RegionMap, !Ref "AWS::Region", "abbreviation"],
            env:  !If [IsProductionAccount, 'P', !If [IsSystemsIntegrationAccount, 'S', 'D']],
            os:   'L',  #Linux
            tier: 'A'   #Application
            }
      -
        Key: "blockCode"
        Value: !Ref blockCode
      -
        Key: "Environment"
        Value: !Ref Environment
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      # SecurityGroupIngress:
      #   -
      #     SourcePrefixListId: !FindInMap [RegionMap, !Ref "AWS::Region", "onpremprefixlist"]
      #     FromPort: 1414
      #     IpProtocol: "tcp"
      #     ToPort: 1414
  MQLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub ${ProjectName}-mq-${osVersion}-${infraAppVersion}
      LaunchTemplateData:
        ImageId: !Ref Ami
        InstanceType: !Ref InstanceType
        # IamInstanceProfile:
        #   Name: !Ref EC2IAMInstanceProfileName
        BlockDeviceMappings:
          - Ebs:
              VolumeSize: !Ref AppsVolumeSize
              VolumeType: gp3
              DeleteOnTermination: true
              Encrypted: true
            DeviceName: /dev/sdc
          - Ebs:
              VolumeSize: !Ref ProductsVolumeSize
              VolumeType: gp3
              DeleteOnTermination: true
              Encrypted: true
            DeviceName: /dev/sdd
          - Ebs:
              VolumeSize: !Ref LogsVolumeSize
              VolumeType: gp3
              DeleteOnTermination: true
              Encrypted: true
            DeviceName: /dev/sde
        TagSpecifications:
          - ResourceType: volume
            Tags:
              - Key: changeGroup
                Value: !Ref changeGroup
              - Key: costCenter
                Value: !Ref costCenter
              - Key: dataClassification
                Value: !Ref dataClassification
              - Key: uniqueId
                Value: !Ref uniqueId
              - Key: supportGroup
                Value: !Ref supportGroup
              - Key: drTier
                Value: !Ref drTier
              - Key: pciIndicator
                Value: !Ref pciIndicator
              - Key: soxIndicator
                Value: !Ref soxIndicator
              - Key: cuiIndicator
                Value: !Ref cuiIndicator
              - Key: phiIndicator
                Value: !Ref phiIndicator
          - ResourceType: instance
            Tags:
              - Key: changeGroup
                Value: !Ref changeGroup
              - Key: costCenter
                Value: !Ref costCenter
              - Key: dataClassification
                Value: !Ref dataClassification
              - Key: uniqueId
                Value: !Ref uniqueId
              - Key: supportGroup
                Value: !Ref supportGroup
              - Key: drTier
                Value: !Ref drTier
              - Key: postConfig
                Value: RHEL-MQSERIES
              - Key: osVersion
                Value: !Ref osVersion
              - Key: infraAppVersion
                Value: !Ref infraAppVersion
              - Key: environment
                Value: !FindInMap [EnvironmentMap, !Ref Environment, "abbreviation"]
              - Key: infraAppSupportEmail
                Value: !FindInMap [WebSMEemailMap, !Ref infraAppSupportEmail, "abbreviation"]
              - Key: appSupportEmail
                Value: !Ref appSupportEmail
              - Key: blockCode
                Value: !Ref blockCode
              - Key: pciIndicator
                Value: !Ref pciIndicator
              - Key: soxIndicator
                Value: !Ref soxIndicator
              - Key: cuiIndicator
                Value: !Ref cuiIndicator
              - Key: phiIndicator
                Value: !Ref phiIndicator
  EC2RuntimeRole:
    Condition: isBaseApplication
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join [ "-", ['delegate-admin', !Ref blockCode]]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - 'ec2.amazonaws.com'
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: "SsmAllowSendCommandViaBlockCode"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Effect: Allow
              Action:
              - ssm:SendCommand
              Resource:
                - !Sub "arn:aws:ec2:*:${AWS::AccountId}:instance/*"
                - !Sub "arn:aws:ssm:*:*:document/*"
              Condition:
                ForAllValues:StringEquals:
                  aws:ResourceTag/blockCode: !Ref blockCode
        - PolicyName: "SsmAllowPolicyForRuntimeEC2"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Effect: Allow
              Action:
              - ssm:DescribeAssociation
              - ssm:GetDeployablePatchSnapshotForInstance
              - ssm:GetDocument
              - ssm:DescribeDocument
              - ssm:GetManifest
              - ssm:GetParameter
              - ssm:GetParameters
              - ssm:ListAssociations
              - ssm:ListInstanceAssociations
              - ssm:PutInventory
              - ssm:PutComplianceItems
              - ssm:PutConfigurePackageResult
              - ssm:UpdateAssociationStatus
              - ssm:UpdateInstanceAssociationStatus
              - ssm:UpdateInstanceInformation
              Resource: "*"
            - Effect: Allow
              Action:
              - ssmmessages:CreateControlChannel
              - ssmmessages:CreateDataChannel
              - ssmmessages:OpenControlChannel
              - ssmmessages:OpenDataChannel
              Resource: "*"
            - Effect: Allow
              Action:
              - ec2messages:AcknowledgeMessage
              - ec2messages:DeleteMessage
              - ec2messages:FailMessage
              - ec2messages:GetEndpoint
              - ec2messages:GetMessages
              - ec2messages:SendReply
              Resource: "*"
            - Effect: Allow
              Action:
              - cloudwatch:PutMetricData
              Resource: "*"
            - Effect: Allow
              Action:
              - ec2:Describe*
              - ec2:*Tags
              Resource: "*"
            - Effect: Allow
              Action:
              - ds:CreateComputer
              - ds:DescribeDirectories
              Resource: "*"
            - Effect: Allow
              Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:DescribeLogGroups
              - logs:DescribeLogStreams
              - logs:PutLogEvents
              Resource: "*"
            - Effect: Allow
              Action:
              - s3:GetBucketLocation
              - s3:PutObject
              - s3:GetObject
              - s3:GetEncryptionConfiguration
              - s3:AbortMultipartUpload
              - s3:ListMultipartUploadParts
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:*Tagging
              Resource: "*"
            - Effect: Allow
              Action:
              - acm:ListCertificates
              - acm:ExportCertificate
              Resource: "*"
            - Effect: Allow
              Action:
              - sns:Publish
              Resource: !Sub "arn:aws:sns:${AWS::Region}:*:*"
        - PolicyName: "SsmDenyPolicyForRuntimeEC2"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Effect: Deny
              Action:
              - ssm:GetParameter
              - ssm:GetParameters
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/delta/ec2/restricted/*"
            - Effect: Deny
              Action:
              - iam:*InstanceProfile
              - ec2:*InstanceProfileAssociations
              Resource: "*"
      # PermissionsBoundary: !Join [":", ["arn:aws:iam:", !Ref AWS::AccountId, "policy/cft-developer-boundary-policy"] ]
  EC2InstanceProfile:
    Condition: isBaseApplication
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      InstanceProfileName: !Join [ "-", ['delegate-admin', !Ref blockCode, 'instance-profile']]
      Path: /
      Roles:
        -
          Ref: EC2RuntimeRole

  # INSTANCE 1
  MQInstance1:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: !Ref KeyName
      LaunchTemplate:
        LaunchTemplateId:  !Ref MQLaunchTemplate
        Version: 1
      NetworkInterfaces:
        - DeviceIndex: 0
          SubnetId: !Ref SubnetId
          GroupSet:
            # - '{{resolve:ssm:/delta/ec2/infrastructure-sg-id:1}}'
            - !Ref MQSecurityGroup
            - !If
              - IsManagedByTower
              - '{{resolve:ssm:/delta/ec2/tower-prd-rhel-sg-id:1}}'
              - !Ref AWS::NoValue
            - !If
              - IsManagedByNonPrdTower
              - '{{resolve:ssm:/delta/ec2/tower-nonprd-rhel-sg-id:1}}'
              - !Ref AWS::NoValue
      Tags:
        # - Key: Name
        #   Value: !GetAtt EC2NamingInvocation1.name

        # - Key: alias
        #   Value: !Sub
        #     - ${prefix}.${accountname}.${suffix}
        #     - {
        #         prefix: !GetAtt EC2NamingInvocation1.name,
        #         accountname: '{{resolve:ssm:/org/member/account_name:1}}',
        #         suffix: aws.delta.com
        #       }
        # - Key: appAlias
        #   Value: !Sub
        #     - "${blockCode}${producttype}${environmentAbbreviation}${ApplicationNumber}01l${ec2subnet}.${hostedzonedomain}"
        #     - {
        #       producttype: !FindInMap [ProductMap, "mqseries", "abbreviation"],
        #       environmentAbbreviation: !FindInMap [EnvironmentMap, !Ref Environment, "singleAbbreviation"],
        #       hostedzonedomain: '{{resolve:ssm:/delta/r53/hostedzonename:1}}',
        #       ec2subnet: !FindInMap [SubnetMap, !Ref SubnetSelection1, "dnssuffix"]
        #       }
        - Key: osPatchGroup
          Value: !Sub
            - os-rhel-${OSPatchEnvironment}-${OSPatchWeek}-${OSPatchDay1}-${OSPatchHour1}00
            - {
              OSPatchEnvironment: !FindInMap [EnvironmentMap, !Ref Environment, "patchabbreviation"],
              OSPatchWeek: !If [IsProductionAccount, 'wk2', 'wk1']
              }
        - Key: infraAppPatchGroup
          Value: !Sub
            - product-rhel-${ProductPatchEnvironment}-${ProductPatchWeek}-${ProductPatchDay1}-${ProductPatchHour1}00
            - {
              ProductPatchEnvironment: !FindInMap [EnvironmentMap, !Ref Environment, "patchabbreviation"],
              ProductPatchWeek: !If [IsProductionAccount, 'wk2', 'wk1']
              }
        - Key: oobPatchGroup
          Value: !If
            - IsProductionAccount
            - !Ref ProdOOBPatchGroup1
            - !FindInMap [EnvironmentMap, !Ref Environment, "oobPatchGroup"]
        - Key: managedByTower
          Value: !Ref managedByTower
  # AppCName1:
  #   # DependsOn: NLBCName
  #   Type: AWS::Route53::RecordSet
  #   Properties:
  #     HostedZoneId: '{{resolve:ssm:/delta/r53/hostedzoneid:1}}'
  #     Name: !Sub
  #       - "${blockCode}${producttype}${environmentAbbreviation}${ApplicationNumber}01l${ec2subnet}.${hostedzonedomain}"
  #       - {
  #         producttype: !FindInMap [ProductMap, "mqseries", "abbreviation"],
  #         environmentAbbreviation: !FindInMap [EnvironmentMap, !Ref Environment, "singleAbbreviation"],
  #         hostedzonedomain: '{{resolve:ssm:/delta/r53/hostedzonename:1}}',
  #         ec2subnet: !FindInMap [SubnetMap, !Ref SubnetSelection1, "dnssuffix"]
  #         }
  #     Type: CNAME
  #     TTL: '300'
  #     ResourceRecords:
  #     - !Sub
  #       - ${prefix}.${accountname}.${suffix}
  #       - {
  #           prefix: !GetAtt EC2NamingInvocation1.name,
  #           accountname: '{{resolve:ssm:/org/member/account_name:1}}',
  #           suffix: aws.delta.com
  #         }
  # AppCNameCertificate1:
  #   Type: 'AWS::CertificateManager::Certificate'
  #   Properties:
  #     CertificateAuthorityArn: !Sub '{{resolve:ssm:/delta/acm/pca/arn:1}}'
  #     DomainName: !Ref AppCName1

  # INSTANCE 2
  MQInstance2:
    Condition: Instance2
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId:  !Ref MQLaunchTemplate
        Version: 1
      NetworkInterfaces:
        - DeviceIndex: 0
          SubnetId: !Ref SubnetId
          GroupSet:
            # - '{{resolve:ssm:/delta/ec2/infrastructure-sg-id:1}}'
            - !Ref MQSecurityGroup
            - !If
              - IsManagedByTower
              - '{{resolve:ssm:/delta/ec2/tower-prd-rhel-sg-id:1}}'
              - !Ref AWS::NoValue
            - !If
              - IsManagedByNonPrdTower
              - '{{resolve:ssm:/delta/ec2/tower-nonprd-rhel-sg-id:1}}'
              - !Ref AWS::NoValue
      Tags:
        # - Key: Name
        #   Value: !GetAtt EC2NamingInvocation2.name

        # - Key: alias
        #   Value: !Sub
        #     - ${prefix}.${accountname}.${suffix}
        #     - {
        #         prefix: !GetAtt EC2NamingInvocation2.name,
        #         accountname: '{{resolve:ssm:/org/member/account_name:1}}',
        #         suffix: aws.delta.com
        #       }
        # - Key: appAlias
        #   Value: !Sub
        #     - "${blockCode}${producttype}${environmentAbbreviation}${ApplicationNumber}02l${ec2subnet}.${hostedzonedomain}"
        #     - {
        #       producttype: !FindInMap [ProductMap, "mqseries", "abbreviation"],
        #       environmentAbbreviation: !FindInMap [EnvironmentMap, !Ref Environment, "singleAbbreviation"],
        #       hostedzonedomain: '{{resolve:ssm:/delta/r53/hostedzonename:1}}',
        #       ec2subnet: !FindInMap [SubnetMap, !Ref SubnetSelection2, "dnssuffix"]
        #       }
        - Key: osPatchGroup
          Value: !Sub
            - os-rhel-${OSPatchEnvironment}-${OSPatchWeek}-${OSPatchDay2}-${OSPatchHour2}00
            - {
              OSPatchEnvironment: !FindInMap [EnvironmentMap, !Ref Environment, "patchabbreviation"],
              OSPatchWeek: !If [IsProductionAccount, 'wk2', 'wk1']
              }
        - Key: infraAppPatchGroup
          Value: !Sub
            - product-rhel-${ProductPatchEnvironment}-${ProductPatchWeek}-${ProductPatchDay2}-${ProductPatchHour2}00
            - {
              ProductPatchEnvironment: !FindInMap [EnvironmentMap, !Ref Environment, "patchabbreviation"],
              ProductPatchWeek: !If [IsProductionAccount, 'wk2', 'wk1']
              }
        - Key: oobPatchGroup
          Value: !If
            - IsProductionAccount
            - !Ref ProdOOBPatchGroup2
            - !FindInMap [EnvironmentMap, !Ref Environment, "oobPatchGroup"]
        - Key: managedByTower
          Value: !Ref managedByTower
  # AppCName2:
  #   Condition: Instance2
  #   # DependsOn: NLBCName
  #   Type: AWS::Route53::RecordSet
  #   Properties:
  #     HostedZoneId: '{{resolve:ssm:/delta/r53/hostedzoneid:1}}'
  #     Name: !Sub
  #       - "${blockCode}${producttype}${environmentAbbreviation}${ApplicationNumber}02l${ec2subnet}.${hostedzonedomain}"
  #       - {
  #         producttype: !FindInMap [ProductMap, "mqseries", "abbreviation"],
  #         environmentAbbreviation: !FindInMap [EnvironmentMap, !Ref Environment, "singleAbbreviation"],
  #         hostedzonedomain: '{{resolve:ssm:/delta/r53/hostedzonename:1}}',
  #         ec2subnet: !FindInMap [SubnetMap, !Ref SubnetSelection2, "dnssuffix"]
  #         }
  #     Type: CNAME
  #     TTL: '300'
  #     ResourceRecords:
  #     - !Sub
  #       - ${prefix}.${accountname}.${suffix}
  #       - {
  #           prefix: !GetAtt EC2NamingInvocation2.name,
  #           accountname: '{{resolve:ssm:/org/member/account_name:1}}',
  #           suffix: aws.delta.com
  #         }
  # AppCNameCertificate2:
  #   Condition: Instance2
  #   Type: 'AWS::CertificateManager::Certificate'
  #   Properties:
  #     CertificateAuthorityArn: !Sub '{{resolve:ssm:/delta/acm/pca/arn:1}}'
  #     DomainName: !Ref AppCName2


#LAMBDAS
  # EC2NamingInvocation1:
  #   Type: AWS::CloudFormation::CustomResource
  #   DeletionPolicy: Retain
  #   Version: "1.0"
  #   Properties:
  #     ServiceToken: !If
  #       - IsProductionAccount
  #       - !Sub arn:aws:sns:${AWS::Region}:094835659498:name_generator_topic
  #       - !Sub arn:aws:sns:${AWS::Region}:148569397242:name_generator_topic
  #     OSVersion: !Ref osVersion
  #     Domain: !Ref DomainEnv
  #     Environment: !FindInMap [EnvironmentMap, !Ref Environment, "mainCategory"]
  #     Region: !Ref "AWS::Region"
  #     ServerType: !Ref ServerType
  # EC2NamingInvocation2:
  #   Condition: Instance2
  #   Type: AWS::CloudFormation::CustomResource
  #   DeletionPolicy: Retain
  #   Version: "1.0"
  #   Properties:
  #     ServiceToken: !If
  #       - IsProductionAccount
  #       - !Sub arn:aws:sns:${AWS::Region}:094835659498:name_generator_topic
  #       - !Sub arn:aws:sns:${AWS::Region}:148569397242:name_generator_topic
  #     OSVersion: !Ref osVersion
  #     Domain: !Ref DomainEnv
  #     Environment: !FindInMap [EnvironmentMap, !Ref Environment, "mainCategory"]
  #     Region: !Ref "AWS::Region"
  #     ServerType: !Ref ServerType
  # EC2InstanceSailpointInvocation1:
  #   Type: AWS::CloudFormation::CustomResource
  #   DeletionPolicy: Retain
  #   Version: "1.0"
  #   Properties:
  #     ServiceToken: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:sailpoint_group_generator_topic
  #     hostName: !GetAtt EC2NamingInvocation1.name
  #     primaryOwner: !Ref AdminPrimaryOwner
  #     secondaryOwners: !Ref AdminSecondaryOwners
  #     environment: !Ref Environment
  #     dataClassification: !FindInMap [DataClassificationMap, !Ref dataClassification, "SailpointDataClassification"]
  #     isPII: !Ref piiIndicator
  #     isPCI: !Ref pciIndicator
  #     isSOX: !Ref soxIndicator
  #     isCUI: !Ref cuiIndicator
  #     isGDPR: !Ref gdprIndicator
  # EC2InstanceSailpointInvocation2:
  #   Condition: Instance2
  #   Type: AWS::CloudFormation::CustomResource
  #   DeletionPolicy: Retain
  #   Version: "1.0"
  #   Properties:
  #     ServiceToken: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:sailpoint_group_generator_topic
  #     hostName: !GetAtt EC2NamingInvocation2.name
  #     primaryOwner: !Ref AdminPrimaryOwner
  #     secondaryOwners: !Ref AdminSecondaryOwners
  #     environment: !Ref Environment
  #     dataClassification: !FindInMap [DataClassificationMap, !Ref dataClassification, "SailpointDataClassification"]
  #     isPII: !Ref piiIndicator
  #     isPCI: !Ref pciIndicator
  #     isSOX: !Ref soxIndicator
  #     isCUI: !Ref cuiIndicator
  #     isGDPR: !Ref gdprIndicator